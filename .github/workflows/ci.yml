name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  # Linux build and test with epoll backend
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]

    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc clang make zlib1g-dev

      - name: Build all targets
        env:
          CC: ${{ matrix.compiler }}
        run: |
          make clean
          make all

      - name: Run core tests
        run: make test

      - name: Run async event loop tests (epoll)
        run: make async-tests

      - name: Verify epoll backend
        run: |
          ./build/tests/test_async_loop | grep "epoll"

      - name: Run integration tests
        run: make integration
        continue-on-error: true

      - name: Run benchmarks
        run: |
          make benchmarks
          ./build/benchmarks/bench_parser
          ./build/benchmarks/bench_memory

      - name: Verify binary sizes
        run: |
          echo "=== Binary Sizes (${{ matrix.compiler }}) ==="
          ls -lh build/examples/ || true
          ls -lh build/tests/ || true
          echo ""
          echo "Core library size:"
          size build/examples/minimal_server || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: linux-${{ matrix.compiler }}-binaries
          path: build/

  # macOS build and test with kqueue backend
  macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          brew install zlib || true

      - name: Build all targets
        run: |
          make clean
          make all

      - name: Run core tests
        run: make test

      - name: Run async event loop tests (kqueue)
        run: make async-tests

      - name: Verify kqueue backend
        run: |
          ./build/tests/test_async_loop | grep "kqueue"

      - name: Run integration tests
        run: make integration
        continue-on-error: true

      - name: Run benchmarks
        run: |
          make benchmarks
          ./build/benchmarks/bench_parser
          ./build/benchmarks/bench_memory

      - name: Verify binary sizes
        run: |
          echo "=== Binary Sizes (macOS) ==="
          ls -lh build/examples/ || true
          ls -lh build/tests/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: macos-binaries
          path: build/

  # Windows build and test with select backend
  windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-zlib
            make

      - name: Build all targets
        shell: msys2 {0}
        run: |
          make clean
          make all

      - name: Run core tests
        shell: msys2 {0}
        run: make test

      - name: Run async event loop tests (select)
        shell: msys2 {0}
        run: make async-tests

      - name: Verify select backend
        shell: msys2 {0}
        run: |
          ./build/tests/test_async_loop.exe | grep "select"

      - name: Verify binary sizes
        shell: msys2 {0}
        run: |
          echo "=== Binary Sizes (Windows) ==="
          ls -lh build/examples/ || true
          ls -lh build/tests/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: windows-binaries
          path: build/

  # Docker build verification
  docker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Build Docker image
        run: docker build -t cwebhttp-test .

      - name: Run all tests in Docker
        run: docker run --rm cwebhttp-test

      - name: Verify epoll backend in Docker
        run: |
          docker run --rm cwebhttp-test /bin/bash -c "./build/tests/test_async_loop | grep 'epoll'"

  # Test summary
  summary:
    runs-on: ubuntu-latest
    needs: [linux, macos, windows, docker]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=== CI Test Summary ==="
          echo "Linux (gcc): ${{ needs.linux.result }}"
          echo "macOS (clang): ${{ needs.macos.result }}"
          echo "Windows (gcc): ${{ needs.windows.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo ""

          if [ "${{ needs.linux.result }}" != "success" ] || \
             [ "${{ needs.macos.result }}" != "success" ] || \
             [ "${{ needs.windows.result }}" != "success" ] || \
             [ "${{ needs.docker.result }}" != "success" ]; then
            echo "❌ Some tests failed!"
            exit 1
          else
            echo "✅ All platform tests passed!"
            echo ""
            echo "Platform Coverage:"
            echo "- Linux: epoll backend ✅"
            echo "- macOS: kqueue backend ✅"
            echo "- Windows: select backend ✅"
            echo "- Docker: epoll backend ✅"
          fi
