name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y build-essential libssl-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install openssl

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install openssl make mingw
          echo "C:\Program Files\OpenSSL-Win64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build & Test
        run: |
          make clean
          make tests
          ./build/tests/test_parse  # и другие потом
          make examples
          # Тест сервера: ./build/examples/minimal_server & sleep 2 && curl -s http://localhost:8080 || echo "Server test skipped (dummy)"

      - name: Check code style (optional)
        run: clang-format --version || echo "No clang-format"
